## 对react fiber的理解
React Fiber 是 React 内部的重新设计的协调引擎（Reconciliation Engine），它于 React 16 开始引入，旨在解决 React 在处理复杂、高频更新时的性能问题。Fiber 的核心思想是将渲染过程拆分为更小的任务单元，并能够中断、暂停和恢复这些任务，以实现更高效的渲染机制。

以下是对 React Fiber 的详细理解：

---

### 1. 为什么需要 Fiber？

在 React 的早期版本中，渲染过程是同步且阻塞的。一旦开始渲染整个组件树，React 会一次性完成所有工作。对于大型或深度嵌套的组件树，这可能会导致以下问题：

- **卡顿**：渲染任务占用了主线程，导致用户界面无法及时响应（如动画、用户输入）。
- **无法优先处理紧急任务**：React 无法区分紧急任务（如用户交互）和普通任务（如后台数据更新）。

React Fiber 的目标是解决这些问题，提供一种灵活的、可中断的渲染机制。

---

### 2. Fiber 的核心思想

Fiber 是 React 的一种实现架构，它的核心思想包括：

- **分片更新（Incremental Rendering）**：将渲染过程拆分为多个小任务，分片执行，允许其他高优先级任务（如用户交互）在中间插入。
- **优先级调度（Scheduling）**：为不同类型的更新任务分配优先级，例如动画、用户输入等高优先级任务会先处理，而低优先级任务（如后台数据更新）会延后处理。
- **可中断和恢复的渲染**：渲染过程可以被中断，稍后从上次中断的地方恢复，保证用户界面的流畅性。

---

### 3. Fiber 是什么？

Fiber 是 React 中表示组件单元的一个数据结构，它本质上是一个轻量级的对象，用来存储每个组件的状态和更新信息。每个组件对应一个 Fiber 节点，Fiber 节点中包含以下信息：

- **类型**：节点的类型（如 `div` 或 React 组件）。
- **状态**：记录组件的当前状态（如挂载状态、更新状态）。
- **优先级**：记录更新任务的优先级，用于任务调度。
- **父节点和兄弟节点**：Fiber 树是一个双向链表结构，便于遍历和操作。
- **生命周期钩子**：记录组件的生命周期方法（如 `componentDidMount`、`componentDidUpdate`）。
- **工作单元**：Fiber 节点可以表示一个独立的工作单元，便于拆分渲染任务。
- **上一次渲染结果**：用于比较新旧 Fiber 节点。

通过 Fiber 数据结构，React 可以更高效地处理组件树的更新和调度。

---

### 4. **Fiber 与传统协调(Reconciliation)的区别**

传统的协调（Reconciliation）过程是同步的，一旦开始，就会从根节点递归更新整个组件树。而 Fiber 的协调过程是异步、增量的，可以分为以下几个阶段：

#### 1. **渲染阶段（Render Phase）**
- Fiber 会遍历组件树，并计算哪些部分需要更新。
- 渲染阶段是可中断的，低优先级任务会暂停，等待高优先级任务（如用户输入）完成后再继续。

#### 2. **提交阶段（Commit Phase）**
- 将渲染阶段计算出的更新应用到 DOM。
- 提交阶段是同步的，不能被中断。

由于渲染阶段是异步的，React Fiber 可以在用户交互时优先响应用户操作，而不是等待整个树的更新完成。

---

### 5. **调度与优先级**

React Fiber 引入了任务调度机制，允许 React 根据任务的优先级选择性地执行更新。React Fiber 中的优先级包括：

- **同步优先级（Synchronous Priority）**：必须立即处理的任务，例如用户输入。
- **过渡优先级（Transition Priority）**：可以延迟处理的任务，例如动画或页面切换。
- **闲置优先级（Idle Priority）**：后台任务，可以在浏览器空闲时执行。

React 使用浏览器的调度 API（如 `requestIdleCallback` 和 `MessageChannel`）来实现这些优先级调度。

---

### 6. **工作原理**

React Fiber 通过构造一个 Fiber 树来表示组件树。Fiber 树的更新过程如下：

1. **创建 Fiber 节点**：每个组件都会生成对应的 Fiber 节点。
2. **遍历 Fiber 树**：根据组件的更新优先级，遍历 Fiber 树，标记需要更新的节点。
3. **Diff 算法**：比较当前 Fiber 树和上一次渲染的 Fiber 树，找出需要更新的部分。
4. **提交更新**：将更新应用到 DOM。

在渲染阶段，React Fiber 使用深度优先遍历（DFS）来遍历 Fiber 树，并可以随时暂停或恢复遍历。

---

### 7. **React Fiber 的优势**

- **更流畅的用户体验**：通过任务拆分和调度，减少了卡顿，保证了动画和用户交互的流畅性。
- **灵活的优先级调度**：**React Fiber** 可以根据任务类型动态调整优先级，高效利用主线程。
- **支持并发模式（Concurrent Mode）**：React Fiber 为并发模式奠定了基础，使 React 能够处理复杂的异步操作。
- **增量渲染（Incremental Rendering）**

---

### 8. **Concurrent Mode 与 Fiber 的关系**

React Fiber 是 Concurrent Mode 的基础。Concurrent Mode 是 React 的一种运行模式，允许组件以更灵活的方式处理异步任务。例如：

- **Suspense**：允许组件在加载数据时暂停渲染。
- **时间切片（Time Slicing）**：将渲染任务分片，以保证高优先级任务的响应速度。

Fiber 的任务调度机制使 Concurrent Mode 成为可能。


---

### 9. **总结**

React Fiber 是 React 的协调引擎，解决了传统同步渲染的性能瓶颈。通过引入 Fiber 树和任务调度机制，React Fiber 实现了以下目标：

- 将渲染过程拆分为更细粒度的任务，支持可中断和恢复。
- 根据任务类型分配优先级，保证用户界面的流畅性。
- 为未来的并发模式（Concurrent Mode）奠定了基础。

React Fiber 的设计使得 React 更加高效、灵活，能够适应复杂的应用场景和用户需求。
