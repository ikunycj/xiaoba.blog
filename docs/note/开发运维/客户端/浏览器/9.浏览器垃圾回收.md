# ä¹ã€æµè§ˆå™¨åƒåœ¾å›æ”¶æœºåˆ¶

## 1. V8çš„åƒåœ¾å›æ”¶æœºåˆ¶æ˜¯
### 1. ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶ï¼ˆGarbage Collection, GCï¼‰ï¼Ÿ

V8 æ˜¯ Chrome å’Œ Node.js è¿è¡Œ JavaScript ä»£ç çš„å¼•æ“ï¼Œå®ƒé‡‡ç”¨ **è‡ªåŠ¨åƒåœ¾å›æ”¶** æœºåˆ¶ï¼Œè´Ÿè´£å›æ”¶**ä¸å†è¢«ä½¿ç”¨çš„å†…å­˜**ï¼Œé˜²æ­¢**å†…å­˜æ³„æ¼**ï¼Œæé«˜ JavaScript ç¨‹åºçš„è¿è¡Œæ•ˆç‡ã€‚

---

### 2. V8 çš„å†…å­˜ç®¡ç†

åœ¨ V8 å¼•æ“ä¸­ï¼Œ**JavaScript çš„å¯¹è±¡å’Œå˜é‡å­˜å‚¨åœ¨å †ï¼ˆHeapï¼‰å’Œæ ˆï¼ˆStackï¼‰ä¸­**ï¼š

- **æ ˆï¼ˆStackï¼‰**ï¼šç”¨äºå­˜å‚¨**åŸºæœ¬æ•°æ®ç±»å‹**ï¼ˆ`Number`ã€`String`ã€`Boolean` ç­‰ï¼‰å’Œ**å‡½æ•°è°ƒç”¨ä¸Šä¸‹æ–‡**ï¼Œå†…å­˜å ç”¨å°ï¼Œè®¿é—®é€Ÿåº¦å¿«ã€‚
- **å †ï¼ˆHeapï¼‰**ï¼šç”¨äºå­˜å‚¨**å¤æ‚æ•°æ®ç±»å‹ï¼ˆå¯¹è±¡ã€æ•°ç»„ã€å‡½æ•°ï¼‰**ï¼Œåƒåœ¾å›æ”¶ä¸»è¦é’ˆå¯¹å †å†…å­˜ã€‚

---

### 3. V8 çš„åƒåœ¾å›æ”¶ç­–ç•¥

V8 é‡‡ç”¨**åˆ†ä»£å›æ”¶æœºåˆ¶**ï¼ˆGenerational Garbage Collectionï¼‰ï¼Œå°†å †å†…å­˜åˆ†ä¸º**æ–°ç”Ÿä»£ï¼ˆYoung Generationï¼‰** å’Œ**è€ç”Ÿä»£ï¼ˆOld Generationï¼‰**ï¼Œåˆ†åˆ«é‡‡ç”¨ä¸åŒçš„å›æ”¶ç®—æ³•ã€‚

#### 3.1 æ–°ç”Ÿä»£ï¼ˆYoung Generationï¼‰

- å­˜æ”¾**ç”Ÿå‘½å‘¨æœŸçŸ­çš„å¯¹è±¡**ï¼ˆå¦‚å±€éƒ¨å˜é‡ã€ä¸´æ—¶å¯¹è±¡ï¼‰ã€‚
- é‡‡ç”¨ **Scavenge ç®—æ³•** è¿›è¡Œåƒåœ¾å›æ”¶ã€‚

##### Scavenge ç®—æ³•ï¼ˆæ–°ç”Ÿä»£å›æ”¶ï¼‰

1. **æ–°ç”Ÿä»£çš„å †åˆ†æˆä¸¤ä¸ªåŒºåŸŸï¼ˆSemi-Spaceï¼‰ï¼š**
    - **From ç©ºé—´**ï¼ˆæ´»è·ƒåŒºï¼‰ï¼šå­˜æ”¾æ­£åœ¨ä½¿ç”¨çš„å¯¹è±¡ã€‚
    - **To ç©ºé—´**ï¼ˆç©ºé—²åŒºï¼‰ï¼šç”¨äº GC å¤åˆ¶å­˜æ´»å¯¹è±¡ã€‚

2. **GC è¿‡ç¨‹**
    - æ‰§è¡Œ Scavenge å›æ”¶æ—¶ï¼Œ**å­˜æ´»å¯¹è±¡è¢«å¤åˆ¶åˆ° To ç©ºé—´ï¼ŒFrom ç©ºé—´æ¸…ç©º**ã€‚
    - äº¤æ¢ From å’Œ To ç©ºé—´çš„è§’è‰²ã€‚
    - **å¤åˆ¶æ¬¡æ•°è¶…è¿‡ä¸€å®šé˜ˆå€¼çš„å¯¹è±¡ï¼Œä¼šè¢«ç§»åŠ¨åˆ°è€ç”Ÿä»£ï¼ˆæ™‹å‡ä¸ºè€ç”Ÿä»£å¯¹è±¡ï¼‰**ã€‚

ğŸ’¡ **ç‰¹ç‚¹**
- **æ•ˆç‡é«˜**ï¼Œå› ä¸ºæ¯æ¬¡åªå¤„ç†å­˜æ´»çš„å¯¹è±¡ï¼Œå›æ”¶é€Ÿåº¦å¿«ã€‚
- é€‚ç”¨äº**çŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡**ï¼Œé¿å…é•¿æ—¶é—´å ç”¨å†…å­˜ã€‚

---

#### 3.2 è€ç”Ÿä»£ï¼ˆOld Generationï¼‰
- å­˜æ”¾**ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿çš„å¯¹è±¡**ï¼ˆå¦‚å…¨å±€å˜é‡ã€é—­åŒ…ï¼‰ã€‚
- é‡‡ç”¨ **æ ‡è®°-æ¸…é™¤ï¼ˆMark-Sweepï¼‰** å’Œ **æ ‡è®°-æ•´ç†ï¼ˆMark-Compactï¼‰** ç®—æ³•å›æ”¶ã€‚

##### æ ‡è®°-æ¸…é™¤ï¼ˆMark-Sweepï¼‰
1. **æ ‡è®°ï¼ˆMarkï¼‰**ï¼šéå†å †å†…å­˜ï¼Œ**æ ‡è®°æ‰€æœ‰å¯è¾¾å¯¹è±¡**ã€‚
2. **æ¸…é™¤ï¼ˆSweepï¼‰**ï¼š**å›æ”¶æœªæ ‡è®°çš„å¯¹è±¡**ï¼Œé‡Šæ”¾å†…å­˜ã€‚

ğŸš« **é—®é¢˜**
- **ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡**ï¼ˆé‡Šæ”¾çš„ç©ºé—´ä¸è¿ç»­ï¼‰ï¼Œå¯èƒ½å½±å“æ€§èƒ½ã€‚

##### æ ‡è®°-æ•´ç†ï¼ˆMark-Compactï¼‰

- **æ ‡è®°å¯è¾¾å¯¹è±¡åï¼Œå°†å­˜æ´»å¯¹è±¡ç§»åŠ¨åˆ°å †çš„ä¸€ä¾§**ï¼Œ**ç„¶åæ¸…é™¤å‰©ä½™ç©ºé—´**ã€‚
- **å‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæé«˜åˆ†é…æ•ˆç‡**ã€‚

ğŸ’¡ **ç‰¹ç‚¹**
- **é€‚ç”¨äºç”Ÿå‘½å‘¨æœŸé•¿çš„å¯¹è±¡**ï¼Œå¦‚å…¨å±€å¯¹è±¡ã€é—­åŒ…ç­‰ã€‚
- **æ¯” Scavenge æ…¢ï¼Œä½†é€‚åˆå¤§å¯¹è±¡ç®¡ç†**ã€‚

---

### 4. V8 çš„å¢é‡å›æ”¶ & å¹¶å‘å›æ”¶

#### 4.1 å¢é‡æ ‡è®°ï¼ˆIncremental Markingï¼‰
- **å°†æ ‡è®°é˜¶æ®µæ‹†æˆå¤šä¸ªå°ä»»åŠ¡**ï¼Œå‡å°‘ä¸»çº¿ç¨‹é˜»å¡æ—¶é—´ï¼Œæé«˜é¡µé¢æµç•…åº¦ã€‚

#### 4.2 å¹¶å‘å›æ”¶ï¼ˆConcurrent GCï¼‰
- **GC æ“ä½œå’Œ JavaScript ä»£ç åŒæ—¶æ‰§è¡Œ**ï¼Œæé«˜æ€§èƒ½ã€‚

---

### 5. è§¦å‘åƒåœ¾å›æ”¶çš„æƒ…å†µ

- **æ–°ç”Ÿä»£ç©ºé—´æ»¡æ—¶**ï¼ˆè§¦å‘ Scavenge å›æ”¶ï¼‰ã€‚
- **è€ç”Ÿä»£ç©ºé—´æ»¡æ—¶**ï¼ˆè§¦å‘ Mark-Sweep æˆ– Mark-Compactï¼‰ã€‚
- **æ˜¾å¼è°ƒç”¨ `global.gc()`**ï¼ˆNode.js éœ€è¦ `--expose-gc`ï¼‰ã€‚
- **æµè§ˆå™¨ç©ºé—²æ—¶**ï¼ˆç°ä»£æµè§ˆå™¨ä¼šåˆ©ç”¨ç©ºé—²æ—¶é—´æ‰§è¡Œ GCï¼‰ã€‚

---

### 6. å†…å­˜æ³„æ¼ & è§£å†³æ–¹æ¡ˆ

#### å¸¸è§çš„ JavaScript å†…å­˜æ³„æ¼

|å†…å­˜æ³„æ¼ç±»å‹|è¯´æ˜|è§£å†³æ–¹æ¡ˆ|
|---|---|---|
|**å…¨å±€å˜é‡**|æœªä½¿ç”¨ `var/let/const` å£°æ˜çš„å˜é‡|`use strict` åŠæ—¶é‡Šæ”¾å˜é‡|
|**é—­åŒ…**|é—­åŒ…å¼•ç”¨å¤–éƒ¨å˜é‡ï¼Œå¯¼è‡´å¯¹è±¡æ— æ³•å›æ”¶|é€‚å½“æ‰‹åŠ¨æ¸…ç†å¼•ç”¨|
|**æœªæ¸…ç†çš„å®šæ—¶å™¨**|`setInterval()` æœªæ¸…é™¤ï¼Œå¯¼è‡´å˜é‡æ— æ³•é‡Šæ”¾|`clearInterval()`|
|**DOM å¼•ç”¨æœªæ¸…é™¤**|äº‹ä»¶ç›‘å¬æœªç§»é™¤|`removeEventListener()`|

---

### 7. æ€»ç»“

| **V8 GC æœºåˆ¶** | **ç­–ç•¥**                                   |
| ------------ | ---------------------------------------- |
| **æ–°ç”Ÿä»£**      | **Scavenge ç®—æ³•**ï¼ˆå¤åˆ¶å­˜æ´»å¯¹è±¡ï¼‰                  |
| **è€ç”Ÿä»£**      | **Mark-Sweep / Mark-Compact**ï¼ˆæ ‡è®°æ¸…é™¤ & æ•´ç†ï¼‰ |
| **ä¼˜åŒ–**       | **å¢é‡æ ‡è®°ã€å¹¶å‘ GC**                           |
| **è§¦å‘æ¡ä»¶**     | æ–°ç”Ÿä»£/è€ç”Ÿä»£ç©ºé—´æ»¡ã€æ‰‹åŠ¨ GC                         |

ğŸ”¥ **V8 é‡‡ç”¨é«˜æ•ˆçš„åˆ†ä»£å›æ”¶æœºåˆ¶ï¼Œä¼˜åŒ–å†…å­˜ç®¡ç†ï¼Œæé«˜ JavaScript æ‰§è¡Œæ•ˆç‡ã€‚**

## 2. å“ªäº›æ“ä½œä¼šé€ æˆå†…å­˜æ³„æ¼ï¼Ÿ

JavaScript è¿è¡Œåœ¨ V8 å¼•æ“ä¸Šï¼Œä½¿ç”¨ **åƒåœ¾å›æ”¶ï¼ˆGCï¼‰** æœºåˆ¶æ¥è‡ªåŠ¨é‡Šæ”¾ä¸å†ä½¿ç”¨çš„å¯¹è±¡ã€‚ä½†å¦‚æœæŸäº›å¯¹è±¡ä»ç„¶è¢«**æ„å¤–å¼•ç”¨**ï¼Œå°±ä¼š**æ— æ³•è¢«å›æ”¶**ï¼Œä»è€Œå¯¼è‡´**å†…å­˜æ³„æ¼ï¼ˆMemory Leakï¼‰**ã€‚

### 1. ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼ï¼Ÿ

**å†…å­˜æ³„æ¼** æŒ‡çš„æ˜¯**ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå·²ç»ä¸å†éœ€è¦çš„å¯¹è±¡ä»ç„¶å ç”¨å†…å­˜ï¼Œå¯¼è‡´å†…å­˜æ— æ³•è¢«å›æ”¶**ï¼Œæœ€ç»ˆå¯èƒ½å¼•å‘ï¼š

- **æ€§èƒ½ä¸‹é™**ï¼ˆå ç”¨è¿‡å¤šå†…å­˜ï¼‰
- **é¡µé¢å¡é¡¿ã€å´©æºƒ**ï¼ˆå†…å­˜æº¢å‡ºï¼‰

---

### 2. å¯¼è‡´ JavaScript å†…å­˜æ³„æ¼çš„ 5 å¤§åŸå› 

#### âŒ 1. å…¨å±€å˜é‡ï¼ˆGlobal Variablesï¼‰

**é—®é¢˜**
- å¦‚æœå˜é‡æ²¡æœ‰ä½¿ç”¨ `var / let / const` å…³é”®å­—å£°æ˜ï¼Œå®ƒä¼šå˜æˆ**å…¨å±€å˜é‡**ï¼Œä¸€ç›´å­˜åœ¨äº `window` å¯¹è±¡ä¸Šï¼Œæ— æ³•å›æ”¶ã€‚

**ç¤ºä¾‹**
```js
function memoryLeak() {
  leak = "This is a memory leak"; // æ²¡æœ‰ `var / let / const`
}
memoryLeak();
console.log(window.leak); // "This is a memory leak"
```

**è§£å†³æ–¹æ¡ˆ** âœ… **ä½¿ç”¨ `use strict` ä¸¥æ ¼æ¨¡å¼**
```js
"use strict";
function memoryLeak() {
  let leak = "This is safe"; // é¿å…æˆä¸ºå…¨å±€å˜é‡
}
memoryLeak();
```

---

#### âŒ 2. æœªæ¸…é™¤çš„å®šæ—¶å™¨å’Œå›è°ƒ

**é—®é¢˜**
- `setInterval()` å’Œ `setTimeout()` ä¼šæŒç»­å¼•ç”¨å¯¹è±¡ï¼Œ**å¦‚æœæ²¡æœ‰æ‰‹åŠ¨æ¸…é™¤ï¼Œå°±ä¼šé€ æˆå†…å­˜æ³„æ¼**ã€‚

**ç¤ºä¾‹**
```js
let element = document.getElementById("leakElement");

setInterval(() => {
  console.log(element.innerText); // ä»ç„¶å¼•ç”¨ element
}, 1000);

// å³ä½¿ element è¢«åˆ é™¤ï¼ŒsetInterval ä»ç„¶æŒæœ‰å¼•ç”¨ï¼Œå¯¼è‡´æ³„æ¼
document.body.removeChild(element);
```

**è§£å†³æ–¹æ¡ˆ** âœ… **åœ¨åˆé€‚çš„æ—¶æœºæ¸…é™¤å®šæ—¶å™¨**
```js
let element = document.getElementById("leakElement");
let interval = setInterval(() => {
  if (!element) {
    clearInterval(interval);
  }
}, 1000);

// å½“å…ƒç´ è¢«åˆ é™¤æ—¶ï¼Œæ‰‹åŠ¨æ¸…ç†
document.body.removeChild(element);
element = null;
```

---

#### âŒ 3. é—­åŒ…ï¼ˆClosuresï¼‰å¯¼è‡´çš„æ„å¤–å¼•ç”¨

**é—®é¢˜**
- é—­åŒ…ä¼š**æŒæœ‰å¯¹å¤–éƒ¨å˜é‡çš„å¼•ç”¨**ï¼Œå¦‚æœä¸æ­£ç¡®é‡Šæ”¾ï¼Œè¿™äº›å˜é‡å°±æ— æ³•è¢«å›æ”¶ã€‚

**ç¤ºä¾‹**
```js
function createLeak() {
  let largeArray = new Array(1000000).fill("I am a leak");

  return function() {
    console.log(largeArray[0]); // largeArray ä¸€ç›´è¢«å¼•ç”¨
  };
}

let leakFunction = createLeak();
```

**è§£å†³æ–¹æ¡ˆ** âœ… **åœ¨åˆé€‚çš„æ—¶å€™æ‰‹åŠ¨é‡Šæ”¾å¼•ç”¨**
```js
function createSafeFunction() {
  let largeArray = new Array(1000000).fill("I am safe");

  return function() {
    console.log(largeArray[0]);
    largeArray = null; // æ‰‹åŠ¨é‡Šæ”¾
  };
}

let safeFunction = createSafeFunction();
safeFunction(); // è®¿é—®åé‡Šæ”¾
```

---

#### âŒ 4. DOM å…ƒç´ å¼•ç”¨æœªæ¸…ç†

**é—®é¢˜**
- å¦‚æœ**åˆ é™¤äº† DOM å…ƒç´ ï¼Œä½† JavaScript ä»ç„¶æŒæœ‰å¯¹å®ƒçš„å¼•ç”¨**ï¼Œåƒåœ¾å›æ”¶æ— æ³•é‡Šæ”¾è¯¥å…ƒç´ ã€‚

**ç¤ºä¾‹**
```js
let div = document.getElementById("myDiv");

document.body.removeChild(div); // åˆ é™¤å…ƒç´ 
console.log(div); // div ä»ç„¶è¢« JavaScript å¼•ç”¨ï¼Œæ— æ³•å›æ”¶
```

**è§£å†³æ–¹æ¡ˆ** âœ… **æ‰‹åŠ¨é‡Šæ”¾å¼•ç”¨**
```js
let div = document.getElementById("myDiv");
document.body.removeChild(div);
div = null; // é‡Šæ”¾å¼•ç”¨
```

---

#### âŒ 5. äº‹ä»¶ç›‘å¬æœªæ¸…é™¤
**é—®é¢˜**
- `addEventListener()` ç»‘å®šçš„äº‹ä»¶ä¼šä¸€ç›´ä¿ç•™ï¼Œå³ä½¿å…ƒç´ è¢«åˆ é™¤ï¼Œä¹Ÿä¸ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚

**ç¤ºä¾‹**
```js
let btn = document.getElementById("myButton");

btn.addEventListener("click", function () {
  console.log("æŒ‰é’®è¢«ç‚¹å‡»");
});

// åˆ é™¤å…ƒç´ 
document.body.removeChild(btn);
```

**ä½†äº‹ä»¶ä»ç„¶å­˜åœ¨ï¼Œæ— æ³•å›æ”¶ï¼**

**è§£å†³æ–¹æ¡ˆ** âœ… **åœ¨åˆ é™¤å…ƒç´ å‰ï¼Œæ‰‹åŠ¨ç§»é™¤äº‹ä»¶**
```js
btn.removeEventListener("click", handleClick);
document.body.removeChild(btn);
btn = null;
```

---

### 3. å¦‚ä½•æ£€æµ‹å†…å­˜æ³„æ¼ï¼Ÿ

#### âœ… ä½¿ç”¨ Chrome å¼€å‘è€…å·¥å…·

1. **æ‰“å¼€ DevTools**ï¼ˆF12 â†’ `Performance` æˆ– `Memory`ï¼‰
2. **è¿è¡Œä»£ç å¹¶è§‚å¯Ÿå†…å­˜ä½¿ç”¨æƒ…å†µ**
3. **ä½¿ç”¨ `Heap Snapshot` æ£€æŸ¥å¯¹è±¡**
4. **è§‚å¯Ÿ `Detached DOM elements`ï¼ˆæœªå›æ”¶çš„ DOMï¼‰**

---

### 4. å¦‚ä½•é¿å… JavaScript å†…å­˜æ³„æ¼ï¼Ÿ

âœ… **æœ€ä½³å®è·µ**
1. **ä½¿ç”¨ `let / const`ï¼Œé¿å…æ„å¤–çš„å…¨å±€å˜é‡**
2. **å®šæ—¶å™¨ï¼ˆ`setInterval`ã€`setTimeout`ï¼‰åœ¨ä¸éœ€è¦æ—¶æ¸…é™¤**
3. **é—­åŒ…ä¸­ä¸å†ä½¿ç”¨çš„å˜é‡æ‰‹åŠ¨ç½® `null`**
4. **åˆ é™¤ DOM æ—¶ï¼Œæ¸…é™¤äº‹ä»¶ç›‘å¬**
5. **ä½¿ç”¨ `WeakMap` / `WeakSet`**ï¼ˆè‡ªåŠ¨å›æ”¶å¼±å¼•ç”¨ï¼‰
6. **ä½¿ç”¨ Chrome DevTools æ£€æµ‹å†…å­˜æ³„æ¼**

---

### 5. æ€»ç»“

| **é—®é¢˜**      | **åŸå› **                   | **è§£å†³æ–¹æ¡ˆ**                |
| ----------- | ------------------------ | ----------------------- |
| **å…¨å±€å˜é‡**    | æœªç”¨ `var / let / const`   | å¼€å¯ `use strict`         |
| **å®šæ—¶å™¨æœªæ¸…é™¤**  | `setInterval()` æŒç»­å¼•ç”¨     | `clearInterval()`       |
| **é—­åŒ…å¼•ç”¨**    | å˜é‡ä¸€ç›´è¢«å‡½æ•°å¼•ç”¨                | ç½® `null`                |
| **DOM æœªæ¸…é™¤** | åˆ é™¤ DOM ä½†ä»æœ‰ JS å¼•ç”¨         | `element = null;`       |
| **äº‹ä»¶ç›‘å¬æœªæ¸…é™¤** | `addEventListener()` ä»å­˜åœ¨ | `removeEventListener()` |

**ğŸ”¥ ç»“è®º**

- **JavaScript é‡‡ç”¨åƒåœ¾å›æ”¶ï¼ˆGCï¼‰æœºåˆ¶ï¼Œä½†é”™è¯¯å¼•ç”¨ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚**
- **åˆç†ä½¿ç”¨ `let / const`ï¼Œæ¸…é™¤å®šæ—¶å™¨ã€äº‹ä»¶ç›‘å¬ã€DOM å¼•ç”¨ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚**
- **ç”¨ DevTools ç›‘æµ‹å†…å­˜ï¼ŒåŠæ—¶ä¼˜åŒ–ï¼**
